name: CI/CD Deploy to Salesforce Sandbox

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Authenticate to Salesforce Sandbox (JWT)
        run: |
          echo "-----BEGIN RSA PRIVATE KEY-----MIIEpQIBAAKCAQEA30GI5tcNaqdo04rvh2IQlFMJHudFpfYn8dBQo+9YGZ2SZAewdiBibV5I6vISa/A9HwZvHDjvrXfLbnpGmwHYeK3cuViNXMDs4w6IiuNIyQ5LixVy+WvksN6iYjXv35bdVriBGg1kghxmQw4ZxcOWAKPYa8vPHynplkpVersQFNYb21n4otGYEcATy5xezwV7JqoijJy70qRCMtY7g4RhjKSmW3t5prc6zkpuShfJtCFOHIQsSGu/VTxYL6gnxN/R5aUsjo6edK5uio0uul4zx/wofdzOQf08aofUSyzUK/o535cbBRu1QHioQGuOwdURuALiLLgXzUQ2mKpD2dEnCwIDAQABAoIBAQDJ2kDjJZEV2yLmEPocl8eRs7nNXSEVuofHFKe0cNRg5JzVIDaltwYHCHY5JoENYnqAsJqJE9lwJ52g16E6yOJlyhyE39GACVakvCEsIe9PCUO4Dr6TUL/GQqTi0w18RLT+kXb4jR9QnEjBW+BldD8NeRZV8EHmVUjC/5ZljvgtPPA4Cb5mux+YJbi4L/PKQAjrce8K4ZlNlLKMeJUcug9rONhxfgMX4mZAM2rsl3R5ZCwx0Xq4e36nW178TYiA/I3s9eCuK0faB3ONvY2hbtASrTShWOSknMaamsglv7+/mqZu17o1CGfJjTg/tYUGgdCgSsD6b2LUSJLeNOuUC+8hAoGBAPNKXhy4mLp73TWekVkXsvDDnWZbeojodRTOFNUK6Og19S+vHW2xybDZnCEiWAnrNeLYEjnuwXqRrMAKoM8MejmsOfXQh4C+L8OneJW3KJSeUKdJAd/yFp84eSJMECe5q2i3c7ewiIyYGTim1gaREgKRF+7qEhYE2rZtEYhbIWSDAoGBAOrrPJ6kJcbWZrALFPoByhAxAeOMDr9qzVZc8Hfk1iTnddb5I3xWyWlITsFs5kGm47RgfpPAVXIoqGRPYizA+zAzQAmYFhuSrFX13o1rxzHinIQXEFtX7AbMCdyi7JKYnFVLKJgG8YwJDMvnvagTJXs0UErUUlMGV9NIT5A1hvzZAoGBAMsBSehTS/WHd3zPVF7v/HsT7tnDCUsGFPQIRa/DC7b/lxhz2W13xWERI0sumiGkp3EidIrso3r/5RLVi3tY4QAQqshneTm++KIcsuzSSUVBmPENZUgVfDTdbY5lw7EyJ0oYkbE716ThIWJ5K+uMz2de5IaRwAepg0pnVhLeX827AoGAC+z7O9Z7cHer6N33J6X1mxLR1LpkeUUzvWGkd4GveVoiulIVghdpzCV2kg00NzsArkSDyH5oGA6GVelNw5Xcapr/cj09ShMNGqQLs0Q4bYjihzYgh3KUMdgj3AaNWffTX+Ub33PiyUggVS2jjCfErFeAh/v1Xe+hf8FZAKom+ykCgYEA8L4dMW8NjXrTeklqHbfHKLnOOg/K21Iaj7ufr6G4JBKD8ZIAG5RNhfJutIOWSyHE3q/EnmcaltKXlQ4+onbPUG232edZ64i5ynvP2BuTXgZP9p21jFRVpWNHKLe7SUfcqXTy6+jVoonVSTH5A/DkJfhIBTvkeTqKI+4WSrUKK5U=-----END RSA PRIVATE KEY-----" > server.key
          sf org login jwt --client-id 3MVG9dZJodJWITSuB5CFu69a8IIeQ6aPCc6M34dCGvS1GNQavfKPaVxjybKxS4xU0xSO_OhTerBCRhbLedxCE \
                           --jwt-key-file server.key \
                           --username bruno.romano182@gmail.com.treinamento \
                           --instance-url https://brunoromano23-dev-ed.my.salesforce.com

      - name: Convert Source to Metadata API Format
        run: sf project convert source --root-dir force-app --output-dir deploy-mdapi

      - name: Validate Deployment (Pre-Check)
        run: sf deploy metadata validate --target-org sandbox --metadata-dir deploy-mdapi --wait 10 --test-level RunLocalTests

      - name: Deploy to Sandbox
        run: sf deploy metadata --target-org sandbox --metadata-dir deploy-mdapi --wait 10 --test-level RunLocalTests